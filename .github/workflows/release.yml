name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download BBDown
      run: |
        Write-Host "Downloading latest BBDown..."
        $response = Invoke-RestMethod -Uri "https://api.github.com/repos/nilaoda/BBDown/releases/latest"
        $asset = $response.assets | Where-Object { $_.name -like "*win-x64.zip" } | Select-Object -First 1
        if ($asset) {
          Write-Host "  Found: $($asset.name)"
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile BBDown.zip
          Expand-Archive -Path BBDown.zip -DestinationPath BBDown-temp
          Move-Item BBDown-temp/BBDown.exe . -Force
          Remove-Item BBDown-temp -Recurse -Force
          Remove-Item BBDown.zip
          
          # éªŒè¯ BBDown.exe æ˜¯å¦å­˜åœ¨
          if (Test-Path "BBDown.exe") {
            Write-Host "âœ“ BBDown downloaded successfully"
            Write-Host "  Location: BBDown.exe"
          } else {
            Write-Error "âœ— BBDown.exe not found!"
            exit 1
          }
        } else {
          Write-Error "BBDown release not found"
          exit 1
        }
      shell: pwsh
    
    - name: Download aria2
      run: |
        Write-Host "Downloading latest aria2..."
        $aria2Url = "https://github.com/aria2/aria2/releases/download/release-1.37.0/aria2-1.37.0-win-64bit-build1.zip"
        Invoke-WebRequest -Uri $aria2Url -OutFile aria2.zip
        Expand-Archive -Path aria2.zip -DestinationPath .
        $aria2Dir = Get-ChildItem -Directory -Filter "aria2-*" | Select-Object -First 1
        Rename-Item $aria2Dir.FullName "aria2"
        Remove-Item aria2.zip
        
        # éªŒè¯ aria2c.exe æ˜¯å¦å­˜åœ¨
        if (Test-Path "aria2\aria2c.exe") {
          Write-Host "âœ“ aria2 downloaded successfully"
          Write-Host "  Location: aria2\aria2c.exe"
        } else {
          Write-Error "âœ— aria2c.exe not found!"
          exit 1
        }
      shell: pwsh
    
    - name: Download ffmpeg
      run: |
        Write-Host "Downloading latest ffmpeg..."
        $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
        Invoke-WebRequest -Uri $ffmpegUrl -OutFile ffmpeg.zip
        Expand-Archive -Path ffmpeg.zip -DestinationPath ffmpeg-temp
        
        # æŸ¥æ‰¾ bin ç›®å½•
        $binDir = Get-ChildItem -Path ffmpeg-temp -Recurse -Directory -Filter "bin" | Select-Object -First 1
        
        if ($binDir) {
          # å¦‚æœæ‰¾åˆ° bin ç›®å½•ï¼Œå°†å…¶å†…å®¹ç§»åŠ¨åˆ° ffmpeg ç›®å½•
          New-Item -ItemType Directory -Path "ffmpeg" -Force | Out-Null
          Get-ChildItem -Path $binDir.FullName | Move-Item -Destination "ffmpeg" -Force
          Write-Host "ffmpeg bin directory found and moved"
        } else {
          # å¦‚æœæ²¡æœ‰ bin ç›®å½•ï¼Œç›´æ¥é‡å‘½åæ•´ä¸ªç›®å½•
          $ffmpegDir = Get-ChildItem -Path ffmpeg-temp -Directory | Select-Object -First 1
          if ($ffmpegDir) {
            Rename-Item $ffmpegDir.FullName "ffmpeg"
          }
        }
        
        Remove-Item ffmpeg-temp -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item ffmpeg.zip
        
        # éªŒè¯ ffmpeg.exe æ˜¯å¦å­˜åœ¨
        if (Test-Path "ffmpeg\ffmpeg.exe") {
          Write-Host "âœ“ ffmpeg downloaded successfully"
          Write-Host "  Location: ffmpeg\ffmpeg.exe"
        } else {
          Write-Error "âœ— ffmpeg.exe not found!"
          exit 1
        }
      shell: pwsh
        
    - name: Verify downloaded files
      run: |
        Write-Host "`n=== Verifying downloaded files ===`n"
        
        Write-Host "BBDown.exe:"
        if (Test-Path "BBDown.exe") {
          $size = (Get-Item "BBDown.exe").Length / 1MB
          Write-Host "  âœ“ Found (${size:N2} MB)"
        } else {
          Write-Host "  âœ— Not found"
        }
        
        Write-Host "`naria2 directory:"
        if (Test-Path "aria2") {
          Get-ChildItem "aria2" | ForEach-Object {
            Write-Host "  - $($_.Name)"
          }
        } else {
          Write-Host "  âœ— Not found"
        }
        
        Write-Host "`nffmpeg directory:"
        if (Test-Path "ffmpeg") {
          Get-ChildItem "ffmpeg" | ForEach-Object {
            Write-Host "  - $($_.Name)"
          }
        } else {
          Write-Host "  âœ— Not found"
        }
        
        Write-Host "`n=== End verification ===`n"
      shell: pwsh
        
    - name: Build executable
      run: python build_exe_minimal.py
      
    - name: Verify release package
      run: |
        Write-Host "`n=== Verifying BBDownG-Release package ===`n"
        
        if (Test-Path "BBDownG-Release") {
          Get-ChildItem "BBDownG-Release" -Recurse | ForEach-Object {
            if ($_.PSIsContainer) {
              Write-Host "ğŸ“ $($_.FullName.Replace((Get-Location).Path + '\BBDownG-Release\', ''))"
            } else {
              $size = $_.Length / 1MB
              Write-Host "ğŸ“„ $($_.FullName.Replace((Get-Location).Path + '\BBDownG-Release\', '')) (${size:N2} MB)"
            }
          }
        } else {
          Write-Error "BBDownG-Release directory not found!"
          exit 1
        }
        
        Write-Host "`n=== End verification ===`n"
      shell: pwsh
    
    - name: Create 7z archive
      run: |
        $version = "${{ github.ref_name }}"
        if ([string]::IsNullOrEmpty($version)) {
          $version = "dev"
        }
        $archiveName = "BBDownG-$version-Windows-x64.7z"
        
        Write-Host "Creating 7z archive: $archiveName"
        
        # ä½¿ç”¨ 7-Zip åˆ›å»ºå‹ç¼©åŒ…ï¼ˆWindows runner è‡ªå¸¦ 7zï¼‰
        7z a -t7z -mx=9 $archiveName ./BBDownG-Release/*
        
        if (Test-Path $archiveName) {
          $size = (Get-Item $archiveName).Length / 1MB
          Write-Host "âœ“ Archive created successfully (${size:N2} MB)"
        } else {
          Write-Error "Failed to create archive"
          exit 1
        }
        
        echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: Create ZIP archive (å¤‡ç”¨)
      run: |
        $version = "${{ github.ref_name }}"
        if ([string]::IsNullOrEmpty($version)) {
          $version = "dev"
        }
        $zipName = "BBDownG-$version-Windows-x64.zip"
        
        Write-Host "Creating ZIP archive: $zipName"
        
        Compress-Archive -Path BBDownG-Release/* -DestinationPath $zipName
        
        if (Test-Path $zipName) {
          $size = (Get-Item $zipName).Length / 1MB
          Write-Host "âœ“ ZIP created successfully (${size:N2} MB)"
        } else {
          Write-Error "Failed to create ZIP"
          exit 1
        }
        
        echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: Upload 7z artifact
      uses: actions/upload-artifact@v4
      with:
        name: BBDownG-Windows-x64-7z
        path: ${{ env.ARCHIVE_NAME }}
        
    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: BBDownG-Windows-x64-zip
        path: ${{ env.ZIP_NAME }}
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.ARCHIVE_NAME }}
          ${{ env.ZIP_NAME }}
        body: |
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          - **7z å‹ç¼©åŒ…**ï¼ˆæ¨èï¼‰ï¼šä½“ç§¯æ›´å°ï¼Œéœ€è¦ 7-Zip è§£å‹
          - **ZIP å‹ç¼©åŒ…**ï¼šWindows åŸç”Ÿæ”¯æŒ
          
          è§£å‹åè¿è¡Œ `BBDownG.exe` å³å¯ä½¿ç”¨ã€‚
          
          ## âœ¨ ä¸»è¦åŠŸèƒ½
          
          - ğŸ¨ ç°ä»£åŒ–å›¾å½¢ç•Œé¢
          - ğŸ” æ‰«ç ç™»å½•æ”¯æŒ
          - ğŸ“¦ æ‰¹é‡ä¸‹è½½
          - âš™ï¸ å®Œæ•´åŠŸèƒ½æ”¯æŒ
          - ğŸš€ è‡ªåŠ¨é…ç½®å·¥å…·è·¯å¾„
          - ğŸ’¾ ä½“ç§¯ä¼˜åŒ–ï¼ˆçº¦ 50MBï¼‰
          
          ## ğŸ“ æ›´æ–°å†…å®¹
          
          è¯¦è§ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          
          ## ğŸ”— ç›¸å…³é“¾æ¥
          
          - é¡¹ç›®ä¸»é¡µ: https://github.com/${{ github.repository }}
          - é—®é¢˜åé¦ˆ: https://github.com/${{ github.repository }}/issues
          - BBDown: https://github.com/nilaoda/BBDown
        draft: false
        prerelease: false
        generate_release_notes: true
        token: ${{ secrets.GITHUB_TOKEN }}
